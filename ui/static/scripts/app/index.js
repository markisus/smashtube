// Generated by CoffeeScript 1.6.3
(function() {
  require(['../main'], function(main) {
    return require(['domReady', 'jquery', 'typeahead', 'ractive', 'underscore', 'text!app/index.template'], function(ready, $, typeahead, Ractive, _, template) {
      var r;
      r = new Ractive({
        el: 'app',
        template: template,
        data: {
          teams: [[], []],
          matches: [[[], []]],
          filter_characters: function(characters, game_id) {
            characters = _.filter(characters, function(character) {
              return _(character.games).findWhere({
                id: game_id
              });
            });
            return characters;
          },
          filter_players: function(teams, players) {
            console.log('filtering players');
            return _.difference(players, _.flatten(teams));
          },
          sort: function(arr, key) {
            return _.sortBy(arr, function(item) {
              return item[key];
            });
          }
        }
      });
      $.getJSON('/api/v1/tournament/', {
        format: 'json',
        limit: 0
      }, function(data) {
        var tournaments;
        tournaments = data.objects;
        return r.set('tournaments', tournaments);
      });
      $.getJSON('/api/v1/player/', {
        format: 'json',
        limit: 0
      }, function(data) {
        var players;
        players = data.objects;
        r.set('players', players);
        return r.set('available_players', players);
      });
      $.getJSON('/api/v1/game-title/', {
        format: 'json',
        limit: 0
      }, function(data) {
        var game_titles;
        game_titles = data.objects;
        return r.set('game_titles', game_titles);
      });
      $.getJSON('/api/v1/character/', {
        format: 'json',
        limit: 0
      }, function(data) {
        var characters;
        characters = data.objects;
        return r.set('characters', characters);
      });
      r.on('add-tournament', function(event) {
        return r.set('adding_tournament', true);
      });
      r.on('cancel-add-tournament', function(event) {
        return r.set('adding_tournament', false);
      });
      r.on('submit-tournament', function(event) {
        var data, req;
        data = {
          name: r.get('tournament_name'),
          date: r.get('tournament_date'),
          location: r.get('tournament_location')
        };
        data = JSON.stringify(data);
        req = $.ajax({
          type: 'POST',
          url: '/api/v1/tournament/',
          data: data,
          dataType: 'text',
          contentType: 'application/json'
        });
        req.done(function(data) {
          var location;
          console.log('done', data);
          location = req.getResponseHeader('Location');
          console.log('Location', location);
          r.set('adding_tournament', false);
          r.set('tournament_name', void 0);
          r.set('tournament_date', void 0);
          r.set('tournament_location', void 0);
          return $.getJSON(location, {
            format: 'json'
          }, function(data) {
            var tournaments;
            console.log('newly created:', data);
            tournaments = r.get('tournaments');
            return tournaments.push(data);
          });
        });
        return req.fail(function(data) {
          var errors;
          errors = JSON.parse(req.responseText);
          return r.set('tournament_errors', errors);
        });
      });
      r.on('edit-tournament', function(event) {
        var context_copy;
        context_copy = _.extend({}, event.context);
        r.set(event.keypath + '.old_name', event.context.name);
        r.set(event.keypath + '.old_date', event.context.date);
        r.set(event.keypath + '.old_location', event.context.location);
        return r.set(event.keypath + '.editing', true);
      });
      r.on('cancel-edit-tournament', function(event) {
        r.set(event.keypath + '.name', event.context.old_name);
        r.set(event.keypath + '.date', event.context.old_date);
        r.set(event.keypath + '.location', event.context.old_location);
        return r.set(event.keypath + '.editing', false);
      });
      r.on('save-tournament', function(event) {
        var data, req;
        console.log(event);
        console.log('saving');
        data = {
          name: event.context.name,
          date: event.context.date,
          location: event.context.location
        };
        data = JSON.stringify(data);
        console.log(data);
        req = $.ajax({
          type: 'PUT',
          url: event.context.resource_uri,
          data: data,
          dataType: 'text',
          contentType: 'application/json'
        });
        return req.done(function() {
          return r.set(event.keypath + '.editing', false);
        });
      });
      r.on('delete-tournament', function(event) {
        var delete_okay, req;
        console.log('delete', event);
        delete_okay = confirm('Are you sure you want to delete ' + event.context.name + '?');
        if (delete_okay) {
          req = $.ajax({
            type: 'DELETE',
            url: event.context.resource_uri
          });
          return req.done(function() {
            var tournaments;
            console.log('splicing');
            tournaments = r.get('tournaments');
            console.log(tournaments);
            return tournaments.splice(event.index.tournament_index, 1);
          });
        }
      });
      r.on('add-player', function(event) {
        return r.set('adding_player', true);
      });
      r.on('cancel-add-player', function(event) {
        return r.set('adding_player', false);
      });
      r.on('submit-player', function(event) {
        var data, req;
        data = {
          handle: r.get('player_handle'),
          first_name: r.get('player_first_name'),
          last_name: r.get('player_last_name')
        };
        data = JSON.stringify(data);
        req = $.ajax({
          type: 'POST',
          url: '/api/v1/player/',
          data: data,
          dataType: 'text',
          contentType: 'application/json'
        });
        req.done(function(data) {
          var location;
          console.log('done', data);
          location = req.getResponseHeader('Location');
          console.log('Location', location);
          r.set('adding_player', false);
          r.set('player_handle', void 0);
          r.set('player_first_name', void 0);
          r.set('player_last_name', void 0);
          return $.getJSON(location, {
            format: 'json'
          }, function(data) {
            var players;
            console.log('newly created:', data);
            players = r.get('players');
            return players.push(data);
          });
        });
        return req.fail(function(data) {
          var errors;
          errors = JSON.parse(req.responseText);
          return r.set('player_errors', errors);
        });
      });
      r.on('edit-player', function(event) {
        r.set(event.keypath + '.old_handle', event.context.handle);
        r.set(event.keypath + '.old_first_name', event.context.first_name);
        r.set(event.keypath + '.old_last_name', event.context.last_name);
        return r.set(event.keypath + '.editing', true);
      });
      r.on('cancel-edit-player', function(event) {
        r.set(event.keypath + '.handle', event.context.old_handle);
        r.set(event.keypath + '.first_name', event.context.old_first_name);
        r.set(event.keypath + '.last_name', event.context.old_last_name);
        return r.set(event.keypath + '.editing', false);
      });
      r.on('save-player', function(event) {
        var data, req;
        console.log(event);
        console.log('saving');
        data = {
          handle: event.context.handle,
          first_name: event.context.first_name,
          last_name: event.context.last_name
        };
        data = JSON.stringify(data);
        console.log(data);
        req = $.ajax({
          type: 'PUT',
          url: event.context.resource_uri,
          data: data,
          dataType: 'text',
          contentType: 'application/json'
        });
        return req.done(function() {
          return r.set(event.keypath + '.editing', false);
        });
      });
      r.on('delete-player', function(event) {
        var delete_okay, req;
        console.log('delete', event);
        delete_okay = confirm('Are you sure you want to delete ' + event.context.handle + '?');
        if (delete_okay) {
          req = $.ajax({
            type: 'DELETE',
            url: event.context.resource_uri
          });
          return req.done(function() {
            var players;
            console.log('splicing');
            players = r.get('players');
            return players.splice(event.index.player_index, 1);
          });
        }
      });
      r.observe('teams', function(current, previous) {
        var players;
        players = r.get('players');
        return r.set('available_players', [players[0]]);
      });
      r.on('set-add-player', function(event, team_index) {
        var player, player_id, players, team, teams;
        console.log('adding with event', event);
        player_id = event.context.player_id;
        players = r.get('available_players');
        console.log('finding player with id', player_id, 'from players', players);
        player = _(players).findWhere({
          id: player_id
        });
        console.log('found player', player);
        team = r.get(event.keypath);
        teams = r.get('teams');
        if (!_(teams).flatten().findWhere({
          id: player_id
        })) {
          team.push(player);
        }
        return console.log(teams);
      });
      r.on('set-remove-player', function(event) {
        var player, player_index, team_index, teams;
        teams = r.get('teams');
        team_index = event.index.team_index;
        player_index = event.index.player_index;
        player = teams[team_index][player_index];
        teams[team_index].splice(player_index, 1);
        return r.set('teams', teams);
      });
      r.on('another-match', function(event) {
        var matches, teams;
        console.log(event);
        matches = r.get('matches');
        teams = r.get('teams');
        console.log(teams);
        console.log(matches);
        return matches.push([]);
      });
      return r.on('remove-match', function(event) {
        var matches;
        console.log('remove');
        matches = r.get('matches');
        return matches.pop();
      });
    });
  });

}).call(this);
