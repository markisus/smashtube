// Generated by CoffeeScript 1.6.3
(function() {
  require(['../main'], function(main) {
    return require(['domReady', 'jquery', 'typeahead', 'ractive', 'underscore', 'text!app/index.template'], function(ready, $, typeahead, Ractive, _, template) {
      var r;
      r = new Ractive({
        el: 'app',
        template: template,
        data: {
          teams: [[], []],
          matches: [
            {
              player_sessions: [[], []],
              link: '',
              start: '',
              end: ''
            }
          ],
          filter_characters: function(characters, game_id) {
            console.log('filter characters', characters, game_id);
            characters = _.filter(characters, function(character) {
              return _(character.games).findWhere({
                id: game_id
              });
            });
            return characters;
          },
          filter_players: function(teams, players) {
            console.log('filtering players');
            return _.difference(players, _.flatten(teams));
          },
          sort: function(arr, key) {
            return _.sortBy(arr, function(item) {
              return item[key];
            });
          }
        }
      });
      $.getJSON('/api/v1/tournament/', {
        format: 'json',
        limit: 0
      }, function(data) {
        var tournaments;
        tournaments = data.objects;
        return r.set('tournaments', tournaments);
      });
      $.getJSON('/api/v1/player/', {
        format: 'json',
        limit: 0
      }, function(data) {
        var available_players, players;
        players = data.objects;
        r.set('players', players);
        available_players = _.clone(players);
        console.log('available', available_players);
        return r.set('available_players', available_players);
      });
      $.getJSON('/api/v1/game-title/', {
        format: 'json',
        limit: 0
      }, function(data) {
        var game_titles;
        game_titles = data.objects;
        return r.set('game_titles', game_titles);
      });
      $.getJSON('/api/v1/character/', {
        format: 'json',
        limit: 0
      }, function(data) {
        var characters;
        characters = data.objects;
        return r.set('characters', characters);
      });
      r.on('display', function(event, name) {
        console.log(event, name);
        return r.set('displayed', name);
      });
      r.on('add-tournament', function(event) {
        return r.set('adding_tournament', true);
      });
      r.on('cancel-add-tournament', function(event) {
        return r.set('adding_tournament', false);
      });
      r.on('submit-tournament', function(event) {
        var data, req;
        data = {
          name: r.get('tournament_name'),
          date: r.get('tournament_date'),
          location: r.get('tournament_location')
        };
        data = JSON.stringify(data);
        req = $.ajax({
          type: 'POST',
          url: '/api/v1/tournament/',
          data: data,
          dataType: 'text',
          contentType: 'application/json'
        });
        req.done(function(data) {
          var location;
          console.log('done', data);
          location = req.getResponseHeader('Location');
          console.log('Location', location);
          r.set('adding_tournament', false);
          r.set('tournament_name', void 0);
          r.set('tournament_date', void 0);
          r.set('tournament_location', void 0);
          return $.getJSON(location, {
            format: 'json'
          }, function(data) {
            var tournaments;
            console.log('newly created:', data);
            tournaments = r.get('tournaments');
            return tournaments.push(data);
          });
        });
        return req.fail(function(data) {
          var errors;
          errors = JSON.parse(req.responseText);
          return r.set('tournament_errors', errors);
        });
      });
      r.on('edit-tournament', function(event) {
        var context_copy;
        context_copy = _.extend({}, event.context);
        r.set(event.keypath + '.old_name', event.context.name);
        r.set(event.keypath + '.old_date', event.context.date);
        r.set(event.keypath + '.old_location', event.context.location);
        return r.set(event.keypath + '.editing', true);
      });
      r.on('cancel-edit-tournament', function(event) {
        r.set(event.keypath + '.name', event.context.old_name);
        r.set(event.keypath + '.date', event.context.old_date);
        r.set(event.keypath + '.location', event.context.old_location);
        return r.set(event.keypath + '.editing', false);
      });
      r.on('save-tournament', function(event) {
        var data, req;
        console.log(event);
        console.log('saving');
        data = {
          name: event.context.name,
          date: event.context.date,
          location: event.context.location
        };
        data = JSON.stringify(data);
        console.log(data);
        req = $.ajax({
          type: 'PUT',
          url: event.context.resource_uri,
          data: data,
          dataType: 'text',
          contentType: 'application/json'
        });
        return req.done(function() {
          return r.set(event.keypath + '.editing', false);
        });
      });
      r.on('delete-tournament', function(event) {
        var delete_okay, req;
        console.log('delete', event);
        delete_okay = confirm('Are you sure you want to delete ' + event.context.name + '?');
        if (delete_okay) {
          req = $.ajax({
            type: 'DELETE',
            url: event.context.resource_uri
          });
          return req.done(function() {
            var tournaments;
            console.log('splicing');
            tournaments = r.get('tournaments');
            console.log(tournaments);
            return tournaments.splice(event.index.tournament_index, 1);
          });
        }
      });
      r.on('add-player', function(event) {
        return r.set('adding_player', true);
      });
      r.on('cancel-add-player', function(event) {
        return r.set('adding_player', false);
      });
      r.on('submit-player', function(event) {
        var data, req;
        data = {
          handle: r.get('player_handle'),
          first_name: r.get('player_first_name'),
          last_name: r.get('player_last_name')
        };
        data = JSON.stringify(data);
        req = $.ajax({
          type: 'POST',
          url: '/api/v1/player/',
          data: data,
          dataType: 'text',
          contentType: 'application/json'
        });
        req.done(function(data) {
          var location;
          console.log('done', data);
          location = req.getResponseHeader('Location');
          console.log('Location', location);
          r.set('adding_player', false);
          r.set('player_handle', void 0);
          r.set('player_first_name', void 0);
          r.set('player_last_name', void 0);
          return $.getJSON(location, {
            format: 'json'
          }, function(data) {
            var available_players, players;
            console.log('newly created:', data);
            players = r.get('players');
            players.push(data);
            available_players = r.get('available_players');
            return available_players.push(data);
          });
        });
        return req.fail(function(data) {
          var errors;
          errors = JSON.parse(req.responseText);
          return r.set('player_errors', errors);
        });
      });
      r.on('edit-player', function(event) {
        r.set(event.keypath + '.old_handle', event.context.handle);
        r.set(event.keypath + '.old_first_name', event.context.first_name);
        r.set(event.keypath + '.old_last_name', event.context.last_name);
        return r.set(event.keypath + '.editing', true);
      });
      r.on('cancel-edit-player', function(event) {
        r.set(event.keypath + '.handle', event.context.old_handle);
        r.set(event.keypath + '.first_name', event.context.old_first_name);
        r.set(event.keypath + '.last_name', event.context.old_last_name);
        return r.set(event.keypath + '.editing', false);
      });
      r.on('save-player', function(event) {
        var data, req;
        console.log(event);
        console.log('saving');
        data = {
          handle: event.context.handle,
          first_name: event.context.first_name,
          last_name: event.context.last_name
        };
        data = JSON.stringify(data);
        console.log(data);
        req = $.ajax({
          type: 'PUT',
          url: event.context.resource_uri,
          data: data,
          dataType: 'text',
          contentType: 'application/json'
        });
        return req.done(function() {
          return r.set(event.keypath + '.editing', false);
        });
      });
      r.on('delete-player', function(event) {
        var delete_okay, req;
        console.log('delete', event);
        delete_okay = confirm('Are you sure you want to delete ' + event.context.handle + '?');
        if (delete_okay) {
          req = $.ajax({
            type: 'DELETE',
            url: event.context.resource_uri
          });
          return req.done(function() {
            var players;
            console.log('splicing');
            players = r.get('players');
            return players.splice(event.index.player_index, 1);
          });
        }
      });
      r.on('team-add-player', function(event, team_index) {
        var match, matches, player, player_id, players, teams, _i, _len;
        teams = r.get('teams');
        team_index = event.index.team_index;
        players = r.get('available_players');
        player_id = r.get('selected_player_id');
        player = _(players).findWhere({
          id: player_id
        });
        teams[team_index].push(player);
        players = _.without(players, player);
        r.set('available_players', players);
        matches = r.get('matches');
        for (_i = 0, _len = matches.length; _i < _len; _i++) {
          match = matches[_i];
          match.player_sessions[team_index].push({
            player: player,
            character: {
              id: void 0
            }
          });
        }
        return r.update('matches');
      });
      r.on('team-remove-player', function(event) {
        var available_players, match, matches, player, team, team_index, _i, _len;
        player = _(r.get('players')).findWhere({
          id: event.context.id
        });
        available_players = r.get('available_players');
        available_players.push(player);
        team_index = event.index.team_index;
        team = r.get('teams.' + team_index);
        team = _.without(team, player);
        r.set('teams.' + team_index, team);
        matches = r.get('matches');
        for (_i = 0, _len = matches.length; _i < _len; _i++) {
          match = matches[_i];
          match.player_sessions[team_index] = _.filter(match.player_sessions[team_index], function(ps) {
            return ps.player.id !== player.id;
          });
        }
        return r.update('matches');
      });
      r.observe('available_players', function(current, old) {
        if (current.length) {
          return r.set('selected_player_id', current[0].id);
        }
      });
      r.on('add-match', function(event) {
        var first_match, first_ps, matches, new_ps, team, team_copy, _i, _len;
        first_match = r.get('matches.0');
        first_ps = first_match.player_sessions;
        new_ps = [];
        for (_i = 0, _len = first_ps.length; _i < _len; _i++) {
          team = first_ps[_i];
          team_copy = _.clone(team);
          new_ps.push(team_copy);
        }
        matches = r.get('matches');
        return matches.push({
          player_sessions: new_ps,
          link: first_match.link,
          start: '',
          end: ''
        });
      });
      r.on('remove-match', function(event) {
        var matches;
        matches = r.get('matches');
        return matches.pop();
      });
      r.observe('teams', function(current, old) {
        var team, _i, _len;
        for (_i = 0, _len = current.length; _i < _len; _i++) {
          team = current[_i];
          if (team.length === 0) {
            r.set('set_error', 'One of the teams has no players!');
            return;
          }
        }
        return r.set('set_error', void 0);
      });
      return r.on('submit-match', function(event) {
        var data, description, game_title_id, game_title_partial, req, set, tournament_id, tournament_partial;
        game_title_id = r.get('set_game_title');
        tournament_id = r.get('set_tournament');
        console.log('tournament id??', tournament_id, _.isNumber(tournament_id));
        if (_.isNumber(tournament_id)) {
          tournament_partial = {
            tournament: '/api/v1/tournament/' + tournament_id + '/'
          };
        } else {
          tournament_partial = {};
        }
        game_title_partial = {
          game_title: '/api/v1/game-title/' + game_title_id + '/'
        };
        description = r.get('set_description');
        set = _.extend({
          description: description,
          matches: []
        }, tournament_partial, game_title_partial);
        data = JSON.stringify(set);
        req = $.ajax({
          type: 'POST',
          url: '/api/v1/set/',
          data: data,
          dataType: 'text',
          contentType: 'application/json'
        });
        return req.done(function() {
          return console.log('DONE!');
        });
      });
    });
  });

}).call(this);
